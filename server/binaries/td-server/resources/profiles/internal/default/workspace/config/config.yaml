#
# Copyright 2024 Tabs Data Inc.
#

# Modes of arguments-passing to workers:
#
# parameters: Arguments to pass directly to the process. The values are provided
#             explicitly and support resolution of environment variables within
#             them.
#
# inherit...: Arguments to pass to the process. The values are derived from the
#             value passed to the same argument in the parent process, allowing
#             inheritance across process chains.
#
# arguments.: Arguments to pass to the process. The values are automatically
#             generated using an internal algorithm based on reserved keywords.
#
# markers...: Arguments to pass to the process. For ephemeral workers, the
#             process is wrapped in a system shell script. As a result, all the
#             argument types above are embedded directly into the script, not
#             passed as command-line arguments.
#             Marker values, however, are passed as direct arguments to the
#             script itself, and are also generated using an internal algorithm
#             based on reserved keywords. These values ar normally used to tag
#             processes for easier tracking.
#
# get-state.: Arguments to pass to the process. The values are generated from an
#             internal key-value map, which is populated by workers that use the
#             'set-state' attribute. These arguments are not passed via the
#             command line, but instead are delivered through the processâ€™s
#             standard input (stdin).

name: tabsdata
controllers:
  init:
    concurrency: 1
    workers:
      - name: bootloader
        kind: processor
        location: relative
        program: bootloader
        inherit:
          - instance
          - repository
          - workspace
          - profile
      - name: server-information
        kind: processor
        location: system
        program: tdsrvinf
        parameters:
          - etc: ${TD_PATH_INSTANCE}/workspace/work/etc
          - available-python-versions-file: available-python-versions.yaml
          - allowed-python-versions-file: allowed-python-versions.yaml
          - valid-python-versions-file: valid-python-versions.yaml
          - server-build-manifest-file: server-build-manifest.yaml
          - server-version-file: server-version.yaml
      - name: apiserver-configuration-resolver
        kind: processor
        location: system
        program: tdcfgrsv
        parameters:
          - input: ${TD_PATH_CONFIG}/proc/regular/apiserver/config/config.yaml
          - strategies: env,hashicorp
          - hashicorp-url: ""
          - hashicorp-token: ""
          - hashicorp-namespace: ""
          - env-hashicorp-url: ""
          - env-hashicorp-token: ""
          - env-hashicorp-namespace: ""
        set-state:
          state-type: blob
          state-key: apiserver-configuration
      - name: apiserver-mounts-options-extractor
        kind: processor
        location: system
        program: tdmntext
        get-states:
          - state-type: blob
            state-key: apiserver-configuration
        set-state:
          state-type: map
          state-key: apiserver-mounts-options
  regular:
    concurrency: 0
    workers:
      - name: apiserver
        kind: processor
        location: relative
        program: apiserver
        parameters:
          - stdin-config: true
          - database-url: file://${TD_URI_REPOSITORY}/database/tabsdata.db
          - ssl-folder: ${TD_PATH_INSTANCE}/workspace/config/ssl
        get-states:
          - state-type: blob
            state-key: apiserver-configuration
      - name: janitor
        kind: processor
        location: system
        program: janitor
        parameters:
          - instance: ${TD_PATH_INSTANCE}
          - frequency: 900 # 15 minutes (seconds)
          - retention: 86400000 # 3 days (milliseconds)
          - limit: 32
        arguments:
          - logs-folder
  ephemeral:
    concurrency: 8
    workers:
      - name: function
        kind: processor
        location: system
        program: tdinvoker
        concurrency: 8
        retries: 2
        arguments:
          - work
          - locks-folder
          - logs-folder
          - bin-folder
          - request-folder
          - response-folder
          - input-folder
          - output-folder
          - current-instance
        markers:
          - td-collection
          - td-function
          - td-worker
          - td-attempt
        get-states:
          - state-type: map
            state-key: apiserver-mounts-options