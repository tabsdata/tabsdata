#
# Copyright 2025 Tabs Data Inc.
#

[tasks.setup]
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/libraries/log.ds

    cm_run_task splash

    project_tabsdata_root_folder = get_env PROJECT_TABSDATA_ROOT_FOLDER
    ko = starts_with ${project_tabsdata_root_folder} "\${"
    if ${ko}
        exit 0
    end

    info "🐢 Runnning task: ${CARGO_MAKE_TASK}"

    os = os_family
    debug "🏈 Current os: ${os}"
    if eq ${os} "windows"
        temp = temp_dir
        marker = join_path ${temp} .td.make
        exists = is_path_exists ${marker}
        info "🍐 The marker temp file is ${marker}"
        if ${exists}
            info "🍅 Marker for make exsits. Skipping setup."
            ok = rm ${marker}
            exit 0
        end
        info "🍏 Marker for make does not exist. Resuming setup."
        ok = touch ${marker}
    else
        pid = pid
        debug "🏀 Current proces id: ${pid}"
        output = exec ps -o ppid= -p ${pid}
        ppid = trim ${output.stdout}
        debug "🥎 Parent process id: ${ppid}"
        temp = temp_dir
        pid_marker = join_path ${temp} .td.pid.${pid}
        ppid_marker = join_path ${temp} .td.pid.${ppid}
        debug "🍊 The pid temp file is ${pid_marker}"
        debug "🍋 The ppid temp file is ${ppid_marker}"
        exists = is_path_exists ${pid_marker}
        if ${exists}
            info "🍅 Marker for pid exsits. Skipping setup."
            ok = rm ${marker}
            exit 0
        end
        debug "🍏 Marker for pid does not exist. Resuming setup."
        ok = touch ${ppid_marker}
    end

    echo ""
    user_home = get_env HOME
    info "🏠 User HOME: ${HOME}"
    echo ""

    no_user_home = eq ${user_home} ""
    if ${no_user_home}
        error "🚷 Environment variable HOME is not defined. Please set it before running this script."
        error "🚷 The USERPROFILE Windows environment variable will not work. Use HOME instead."
        echo ""
        exit 1
    end

    user_home_exists = is_path_exists ${user_home}
    if not ${user_home_exists}
        error "🚷 Environment variable HOME points to a non-existing path: ${user_home}"
        echo ""
        exit 1
    end

    user_home_is_dir = is_dir ${user_home}
    if not ${user_home_is_dir}
        error "🚷 Environment variable HOME points to a non-folder path: ${user_home}"
        echo ""
        exit 1
    end

    PATH = get_env PATH
    debug "✅ Real PATH: ${PATH}"

    make_task = get_env CARGO_MAKE_TASK
    if eq ${make_task} "docs"
        noop
    else
        cm_run_task permit
    end
    ''']

