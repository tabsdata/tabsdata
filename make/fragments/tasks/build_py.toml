#
# Copyright 2025 Tabs Data Inc.
#

[tasks.build_py]
category = "03 - Build"
description = "Task 'build' for Python projects"
run_task = [
    { name = [
        "build_py_ta_features",
        "build_py_ta_tableframe",
        "build_py_te_examples",
        "build_py_te_tableframe",
        "build_py_ty_tableframe",
        "build_py_tabsdata",
        "build_py_connectors",
    ] }
]

[tasks.build_py_ta_features]
category = "03 - Build"
private = true

[tasks.build_py_ta_tableframe]
category = "03 - Build"
private = true

[tasks.build_py_te_examples]
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/libraries/log.ds

    cd "${PROJECT_PY_TE_EXAMPLES_FOLDER}/tabsdata/extensions/_examples/guides"

    debug "ðŸš€ mdbook build"
    exec --fail-on-error mdbook build
    ''']

[tasks.build_py_te_tableframe]
category = "03 - Build"
private = true

[tasks.build_py_ty_tableframe]
category = "03 - Build"
private = true

[tasks.build_py_tabsdata]
category = "03 - Build"
private = true

[tasks.build_py_connectors]
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/libraries/log.ds

    connectors = glob_array ${CONNECTORS_PY_ROOT_FOLDER}/tabsdata_*

    for connector in ${connectors}
        is_connector = is_dir ${connector}
        if ${is_connector}
        end
    end
    ''']

[tasks.link_py]
category = "03 - Build"
description = "Task 'link' for Python projects"

[tasks.egg_py]
category = "03 - Build"
description = "Task 'egg' for Python projects"
run_task = [
    { name = [
        "egg_py_ta_features",
        "egg_py_ta_tableframe",
        "egg_py_te_examples",
        "egg_py_te_tableframe",
        "egg_py_ty_tableframe",
        "egg_py_tabsdata",
        "egg_py_connectors",
    ] }
]

[tasks.egg_py_ta_features]
category = "03 - Build"
private = true

[tasks.egg_py_ta_tableframe]
category = "03 - Build"
private = true

[tasks.egg_py_te_examples]
category = "03 - Build"
private = true

[tasks.egg_py_te_tableframe]
category = "03 - Build"
private = true

[tasks.egg_py_ty_tableframe]
category = "03 - Build"
private = true

[tasks.egg_py_tabsdata]
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/libraries/log.ds

    set_env PYTHONWARNINGS ignore

    debug "ðŸ”· ðŸ”· _____ Setting up tabsdata pytest context (tabsdata)..."
    cd ${PROJECT_TABSDATA_ROOT_FOLDER}
    debug "ðŸš€ python setup.py --quiet develop --script-dir target/pytest/build"
    exec --fail-on-error python setup.py --quiet develop --script-dir target/pytest/build

    # Prevent make from using the local system scripts generated by setup.py
    rm target/pytest/build/pip
    rm target/pytest/build/pip.exe
    rm target/pytest/build/pip3
    rm target/pytest/build/pip3.exe
    rm target/pytest/build/wheel
    rm target/pytest/build/wheel.exe
    ''']

[tasks.egg_py_connectors]
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/libraries/log.ds

    set_env PYTHONWARNINGS ignore

    cd ${PROJECT_TABSDATA_ROOT_FOLDER}

    connectors = glob_array ${CONNECTORS_PY_ROOT_FOLDER}/tabsdata_*

    for connector in ${connectors}
        is_connector = is_dir ${connector}
        if ${is_connector}
            connector_name = basename ${connector}

            debug "ðŸ”· ðŸ”· _____ Setting up tabsdata pytest context (${connector_name})..."
            cd ${connector}
            debug "ðŸš€ python setup.py --quiet develop --script-dir target/pytest/build"
            exec --fail-on-error python setup.py --quiet develop --script-dir target/pytest/build

            # Prevent make from using the local system scripts generated by setup.py
            rm target/pytest/build/pip
            rm target/pytest/build/pip.exe
            rm target/pytest/build/pip3
            rm target/pytest/build/pip3.exe
            rm target/pytest/build/wheel
            rm target/pytest/build/wheel.exe

            cd ${PROJECT_TABSDATA_ROOT_FOLDER}
        end
    end
    ''']