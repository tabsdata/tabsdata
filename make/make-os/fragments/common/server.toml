#
# Copyright 2025 Tabs Data Inc.
#

[tasks.__os__set_venv_env]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ§¹ Setting environment variables for python virtual environments..."

    conda_prefix_ = get_env CONDA_PREFIX
    conda_default_env_ = get_env CONDA_DEFAULT_ENV
    conda_shlvl_ = get_env CONDA_SHLVL
    conda_prompt_modifier_ = get_env CONDA_PROMPT_MODIFIER
    dyld_library_path_ = get_env DYLD_LIBRARY_PATH
    ld_library_path_ = get_env LD_LIBRARY_PATH
    path_ = get_env PATH

    set_env _CONDA_PREFIX ${conda_prefix_}
    set_env _CONDA_DEFAULT_ENV ${conda_default_env_}
    set_env _CONDA_SHLVL ${conda_shlvl_}
    set_env _CONDA_PROMPT_MODIFIER ${conda_prompt_modifier_}
    set_env _DYLD_LIBRARY_PATH ${dyld_library_path_}
    set_env _LD_LIBRARY_PATH ${ld_library_path_}
    set_env _PATH ${path_}

    unset_env CONDA_PREFIX
    unset_env CONDA_DEFAULT_ENV
    unset_env CONDA_SHLVL
    unset_env CONDA_PROMPT_MODIFIER
    if not is_empty ${conda_prefix_}
        os = os_family
        if eq ${os} "windows"
            separator = set ";"
        else
            separator = set ":"
        end
        if not eq ${os} "windows"
            if not is_empty ${dyld_library_path_}
                dyld_library_path__ = array
                dyld_library_path__elements = split ${dyld_library_path_} ${separator}
                for dyld_library_path__element in ${dyld_library_path__elements}
                    dyld_library_path__element = trim ${dyld_library_path__element}
                    if not is_empty ${dyld_library_path__element}
                        contains_conda = contains ${dyld_library_path__element} ${conda_prefix_}
                        if not ${contains_conda}
                            array_push ${dyld_library_path__} ${dyld_library_path__element}
                        end
                    end
                end
                dyld_library_path__ = array_join ${dyld_library_path__} ${separator}
                set_env DYLD_LIBRARY_PATH ${dyld_library_path__}
            end
            if not is_empty ${ld_library_path_}
                ld_library_path__ = array
                ld_library_path__elements = split ${ld_library_path_} ${separator}
                for ld_library_path__element in ${ld_library_path__elements}
                    ld_library_path__element = trim ${ld_library_path__element}
                    if not is_empty ${ld_library_path__element}
                        contains_conda = contains ${ld_library_path__element} ${conda_prefix_}
                        if not ${contains_conda}
                            array_push ${ld_library_path__} ${ld_library_path__element}
                        end
                    end
                end
                ld_library_path__ = array_join ${ld_library_path__} ${separator}
                set_env LD_LIBRARY_PATH ${ld_library_path__}
            end
        else
            if not is_empty ${path_}
                path__ = array
                path__elements = split ${path_} ${separator}
                for path__element in ${path__elements}
                    path__element = trim ${path__element}
                    if not is_empty ${path__element}
                        contains_conda = contains ${path__element} ${conda_prefix_}
                        if not ${contains_conda}
                            array_push ${path__} ${path__element}
                        end
                    end
                end
                path__ = array_join ${path__} ${separator}
                set_env PATH ${path__}
            end
        end
    end
    ''']

[tasks.__os__reset_venv_env]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "â™»ï¸ Resetting environment variables for python virtual environments..."

    _conda_prefix = get_env _CONDA_PREFIX
    _conda_default_env = get_env _CONDA_DEFAULT_ENV
    _conda_shlvl = get_env _CONDA_SHLVL
    _conda_prompt_modifier = get_env _CONDA_PROMPT_MODIFIER
    _dyld_library_path = get_env _DYLD_LIBRARY_PATH
    _ld_library_path = get_env _LD_LIBRARY_PATH
    _path = get_env _PATH

    if not is_empty ${_conda_prefix}
        set_env CONDA_PREFIX ${_conda_prefix}
    end
    if not is_empty ${_conda_default_env}
        set_env CONDA_DEFAULT_ENV ${_conda_default_env}
    end
    if not is_empty ${_conda_shlvl}
        set_env CONDA_SHLVL ${_conda_shlvl}
    end
    if not is_empty ${_conda_prompt_modifier}
        set_env CONDA_PROMPT_MODIFIER ${_conda_prompt_modifier}
    end
    if not is_empty ${_dyld_library_path}
        set_env DYLD_LIBRARY_PATH ${_dyld_library_path}
    end
    if not is_empty ${_ld_library_path}
        set_env LD_LIBRARY_PATH ${_ld_library_path}
    end
    if not is_empty ${_path}
        set_env PATH ${_path}
    end

    unset_env _CONDA_PREFIX
    unset_env _CONDA_DEFAULT_ENV
    unset_env _CONDA_SHLVL
    unset_env _CONDA_PROMPT_MODIFIER
    unset_env _DYLD_LIBRARY_PATH
    unset_env _LD_LIBRARY_PATH
    unset_env _PATH
    ''']

[tasks.__os__show_venv_env]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ” Current environment variables for python virtual environments..."

    __conda_prefix = get_env CONDA_PREFIX
    __conda_default_env = get_env CONDA_DEFAULT_ENV
    __conda_shlvl = get_env CONDA_SHLVL
    __dyld_library_path = get_env DYLD_LIBRARY_PATH
    __ld_library_path = get_env LD_LIBRARY_PATH
    __path = get_env PATH
    debug "   CONDA_PREFIX=${__conda_prefix}"
    debug "   CONDA_DEFAULT_ENV=${__conda_default_env}"
    debug "   CONDA_SHLVL=${__conda_shlvl}"
    debug "   DYLD_LIBRARY_PATH=${__dyld_library_path}"
    debug "   LD_LIBRARY_PATH=${__ld_library_path}"
    debug "   PATH=${__path}"
    ''']

[tasks.__os__ps_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸš€ python ${PS_SUPERVISORS_SCRIPT}"
    exec --fail-on-error python ${PS_SUPERVISORS_SCRIPT}
    ''']

[tasks.__os__start_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Starting tabsdata testing servers..."

    debug "ğŸ”´ï¸ Before set..."
    cm_run_task __os__show_venv_env

    cm_run_task __os__set_venv_env

    debug "ğŸŸ¢ After set..."
    cm_run_task __os__show_venv_env

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"

        instances = exec --fail-on-error python ${TESTING_INSTANCES_SCRIPT} ${TESTING_SUPERVISORS_CONFIG}
        instances = split ${instances.stdout} "\n"

        for instance in ${instances}
            instance = trim ${instance}
            if not is_empty ${instance}
                info "ğŸ”… Starting instance: ${instance}"

                instance_arguments = array
                array_push ${instance_arguments} ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
                array_push ${instance_arguments} start
                array_push ${instance_arguments} --instance
                array_push ${instance_arguments} ${instance}
                array_push ${instance_arguments} --

                debug "ğŸš€ python ${TESTING_INSTANCE_SCRIPT} ${TESTING_SUPERVISORS_CONFIG} ${instance}"
                instance_config = exec --fail-on-error python ${TESTING_INSTANCE_SCRIPT} ${TESTING_SUPERVISORS_CONFIG} ${instance}
                instance_config = trim ${instance_config.stdout}
                debug "ğŸ”… Output of yaml parser for ${instance}:\n ${instance_config}"

                instance_parameters = split ${instance_config.stdout} "\n"
                for yaml_line in ${instance_parameters}
                    yaml_line = trim ${yaml_line}
                    if not is_empty ${yaml_line}
                        array_push ${instance_arguments} ${yaml_line}
                    end
                end

                command = array_join ${instance_arguments} " "
                debug "ğŸš€ ${command}"

                on_ga = get_env TD_ON_GA
                on_ga_true = eq ${on_ga} "true"
                os = os_family
                if eq ${os} "windows"
                    exec --fail-on-error %{command}
                else
                    if ${on_ga_true}
                        exec --fail-on-error %{command}
                    else
                        spinner = spawn python ${SPINNER_SCRIPT} "Waiting for the instance ${instance} to start..."
                        output = exec --fail-on-error %{command}
                        exec kill ${spinner}
                        sleep 2000
                        code = set ${output.code}
                        if not eq ${code} 0
                            error "ğŸš« Failed to start instance ${instance}."
                            error "ğŸ›ğŸ‘€ Result >>>>>"
                            error "ğŸ›ğŸ‘€ <out.i>"
                            error "${output.stdout}"
                            error "ğŸ›ğŸ‘€ <out.f>"
                            error "ğŸ›ğŸ‘€ <err.i>"
                            error "${output.stderr}"
                            error "ğŸ›ğŸ‘€ <err.f>"
                            error "ğŸ›ğŸ‘€ <code.i>"
                            error "${output.code}"
                            error "ğŸ›ğŸ‘€ <code.f>"
                            error "ğŸ›ğŸ‘€ <<<<<"
                            assert_fail
                        end
                    end
                end
            end
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata start."
    end

    cm_run_task __os__ps_pytest_tabsdata_servers

    debug "ğŸŸ¢ï¸ Before reset..."
    cm_run_task __os__show_venv_env

    cm_run_task __os__reset_venv_env

    debug "ğŸ”´ After reset..."
    cm_run_task __os__show_venv_env
    ''']

[tasks.__os__status_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Checking tabsdata testing servers..."

    debug "ğŸ”´ï¸ Before set..."
    cm_run_task __os__show_venv_env

    cm_run_task __os__set_venv_env

    debug "ğŸŸ¢ After set..."
    cm_run_task __os__show_venv_env

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"

        instances = exec --fail-on-error python ${TESTING_INSTANCES_SCRIPT} ${TESTING_SUPERVISORS_CONFIG}
        instances = split ${instances.stdout} "\n"

        for instance in ${instances}
            instance = trim ${instance}
            if not is_empty ${instance}
                info "ğŸ¯ Checking instance: ${instance}"

                supervisor_workers_config_folder_exists = is_path_exists ${SUPERVISOR_WORKERS_CONFIG_FOLDER}
                workers = array
                if ${supervisor_workers_config_folder_exists}
                    supervisor_workers = exec --fail-on-error python -c "import os, sys; path = sys.argv[1]; print('\\n'.join(sorted(name for name in os.listdir(path) if os.path.isdir(os.path.join(path, name)))))" ${SUPERVISOR_WORKERS_CONFIG_FOLDER}
                    supervisor_workers = trim ${supervisor_workers.stdout}
                    supervisor_workers = split ${supervisor_workers} "\n"
                    for supervisor_worker in ${supervisor_workers}
                        supervisor_worker = trim ${supervisor_worker}
                        if not is_empty ${supervisor_worker}
                            debug "ğŸ“ Selecting worker: ${supervisor_worker}"
                            array_push ${workers} ${supervisor_worker}
                        end
                    end
                else
                    warn "âš ï¸ Supervisor regular workers config folder not found: ${SUPERVISOR_WORKERS_CONFIG_FOLDER}"
                end
                workers_list = array_join ${workers} ", "
                if is_empty ${workers_list}
                    debug "â“ No regular supervisor workers configured under ${SUPERVISOR_WORKERS_CONFIG_FOLDER}"
                else
                    debug "ğŸŒ€ Supervisor workers to check: ${workers_list}"
                end

                debug "ğŸš€ ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} status --instance ${instance}"

                status_timeout = calc 5 * 60
                status_sleep = set 10000
                status_attempts = calc ${status_timeout} * 1000
                status_attempts = calc ${status_attempts} / ${status_sleep}

                status_attempt = set 0
                status_checking = set true

                while ${status_checking}
                    output_timestamp = exec --fail-on-error python -c "from datetime import datetime; print(datetime.now().isoformat())"
                    current_timestamp = trim ${output_timestamp.stdout}
                    info "â˜•ï¸ (${current_timestamp}) Checking workers..."

                    output = exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} status --instance ${instance}

                    workers_started = set true
                    stopped_workers = array
                    for worker in ${workers}
                        worker = trim ${worker}
                        if not is_empty ${worker}
                            info "ğŸ”… Checking worker: ${worker}"
                            worker_started = contains ${output.stdout} ${worker}
                            if not ${worker_started}
                                info "   ğŸ”´ Worker ${worker} is not running"
                                workers_started = set false
                                array_push ${stopped_workers} ${worker}
                            else
                                info "   ğŸŸ¢ Worker ${worker} is running"
                            end
                        end
                    end

                    if ${workers_started}
                        if is_empty ${workers_list}
                            info "ğŸš¦ Verified supervisor is running"
                        else
                            info "ğŸš¦ Verified supervisor & (${workers_list}) are running"
                        end
                        status_checking = set false
                    else
                        stopped_workers_list = array_join ${stopped_workers} ", "
                        debug ". ${status_attempt}"
                        if not is_empty ${stopped_workers_list}
                            debug "ğŸ‘€ Waiting for workers: ${stopped_workers_list}"
                        end
                        status_attempt = calc ${status_attempt} + 1
                        status_exhausted = eq ${status_attempt} ${status_attempts}
                        if ${status_exhausted}
                            error "ğŸ˜¡ Cancelling execution as supervisor did not start after ${status_timeout} seconds"
                            error "ğŸ›ğŸ‘€ Supervisor status >>>>>"
                            error "ğŸ›ğŸ‘€ <out.i>"
                            error "${output.stdout}"
                            error "ğŸ›ğŸ‘€ <out.f>"
                            error "ğŸ›ğŸ‘€ <err.i>"
                            error "${output.stderr}"
                            error "ğŸ›ğŸ‘€ <err.f>"
                            error "ğŸ›ğŸ‘€ <code.i>"
                            error "${output.code}"
                            error "ğŸ›ğŸ‘€ <code.f>"
                            error "ğŸ›ğŸ‘€ <<<<<"
                            assert_fail
                        end
                        sleep ${status_sleep}
                    end
                end
            end
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata status."
    end

    cm_run_task __os__ps_pytest_tabsdata_servers

    debug "ğŸŸ¢ï¸ Before reset..."
    cm_run_task __os__show_venv_env

    cm_run_task __os__reset_venv_env

    debug "ğŸ”´ After reset..."
    cm_run_task __os__show_venv_env
    ''']

[tasks.__os__stop_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Stopping tabsdata testing servers..."

    debug "ğŸ”´ï¸ Before set..."
    cm_run_task __os__show_venv_env

    cm_run_task __os__set_venv_env

    debug "ğŸŸ¢ After set..."
    cm_run_task __os__show_venv_env

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"

        instances = exec --fail-on-error python ${TESTING_INSTANCES_SCRIPT} ${TESTING_SUPERVISORS_CONFIG}
        instances = split ${instances.stdout} "\n"

        for instance in ${instances}
            instance = trim ${instance}
            if not is_empty ${instance}
                info "ğŸ”… Stopping instance: ${instance}"

                debug "ğŸš€ ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance ${instance}"

                on_ga = get_env TD_ON_GA
                on_ga_true = eq ${on_ga} "true"

                if ${on_ga_true}
                    exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance ${instance}
                else
                    output = exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance ${instance}
                end
            end
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata status."
    end

    cm_run_task __os__ps_pytest_tabsdata_servers

    debug "ğŸŸ¢ï¸ Before reset..."
    cm_run_task __os__show_venv_env

    cm_run_task __os__reset_venv_env

    debug "ğŸ”´ After reset..."
    cm_run_task __os__show_venv_env
    ''']

[tasks.__os__drop_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Deleteing tabsdata testing servers..."

    home_folder = set ${HOME}

    instances = exec --fail-on-error python ${TESTING_INSTANCES_SCRIPT} ${TESTING_SUPERVISORS_CONFIG}
    instances = split ${instances.stdout} "\n"

    for instance in ${instances}
        instance = trim ${instance}
        if not is_empty ${instance}
            info "ğŸ”… Droping instance: ${instance}"

            instance_folder = set ${home_folder}/.tabsdata/instances/${instance}
            debug "âœ… The tabsdata instance ${instance} folder is: ${instance_folder}"
            exists_instance_folder = is_path_exists ${instance_folder}
            if eq ${exists_instance_folder} true
                debug "âœ… The tabsdata instance ${instance} folder exists. Deleting it: ${target_dir}..."
                rm -r ${instance_folder}
                debug "âœ… The tabsdata instance ${instance} has been deleted: ${target_dir}!"
            else
                debug "âœ… The tabsdata instance ${instance} folder does not exist. Skipping deleting it: ${target_dir}."
            end
        end
    end
    ''']
