#
# Copyright 2025 Tabs Data Inc.
#

[tasks.__os__ps_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸš€ python ${PS_SUPERVISORS_SCRIPT}"
    exec --fail-on-error python ${PS_SUPERVISORS_SCRIPT}
    ''']

[tasks.__os__start_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Starting tabsdata testing servers..."

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"

        instances = exec --fail-on-error python ${TESTING_INSTANCES_SCRIPT} ${TESTING_SUPERVISORS_CONFIG}
        instances = split ${instances.stdout} "\n"

        for instance in ${instances}
            instance = trim ${instance}
            if not is_empty ${instance}
                info "ğŸ”… Starting instance: ${instance}"

                instance_arguments = array
                array_push ${instance_arguments} ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
                array_push ${instance_arguments} start
                array_push ${instance_arguments} --instance
                array_push ${instance_arguments} ${instance}
                array_push ${instance_arguments} --

                debug "ğŸš€ python ${TESTING_INSTANCE_SCRIPT} ${TESTING_SUPERVISORS_CONFIG} ${instance}"
                instance_config = exec --fail-on-error python ${TESTING_INSTANCE_SCRIPT} ${TESTING_SUPERVISORS_CONFIG} ${instance}
                instance_config = trim ${instance_config.stdout}
                debug "ğŸ”… Output of yaml parser for ${instance}:\n ${instance_config}"

                instance_parameters = split ${instance_config.stdout} "\n"
                for yaml_line in ${instance_parameters}
                    yaml_line = trim ${yaml_line}
                    if not is_empty ${yaml_line}
                        array_push ${instance_arguments} ${yaml_line}
                    end
                end

                command = array_join ${instance_arguments} " "
                debug "ğŸš€ ${command}"

                on_ga = get_env TD_ON_GA
                on_ga_true = eq ${on_ga} "true"
                os = os_family
                if eq ${os} "windows"
                    exec --fail-on-error %{command}
                else
                    if ${on_ga_true}
                        exec --fail-on-error %{command}
                    else
                        spinner = spawn python ${SPINNER_SCRIPT} "Waiting for the instance ${instance} to start..."
                        output = exec --fail-on-error %{command}
                        exec kill ${spinner}
                        sleep 2000
                        code = set ${output.code}
                        if not eq ${code} 0
                            error "ğŸš« Failed to start instance ${instance}."
                            error "ğŸ›ğŸ‘€ Result >>>>>"
                            error "ğŸ›ğŸ‘€ <out.i>"
                            error "${output.stdout}"
                            error "ğŸ›ğŸ‘€ <out.f>"
                            error "ğŸ›ğŸ‘€ <err.i>"
                            error "${output.stderr}"
                            error "ğŸ›ğŸ‘€ <err.f>"
                            error "ğŸ›ğŸ‘€ <code.i>"
                            error "${output.code}"
                            error "ğŸ›ğŸ‘€ <code.f>"
                            error "ğŸ›ğŸ‘€ <<<<<"
                            assert_fail
                        end
                    end
                end
            end
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata start."
    end

    cm_run_task __os__ps_pytest_tabsdata_servers
    ''']

[tasks.__os__status_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Checking tabsdata testing servers..."

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"

        instances = exec --fail-on-error python ${TESTING_INSTANCES_SCRIPT} ${TESTING_SUPERVISORS_CONFIG}
        instances = split ${instances.stdout} "\n"

        for instance in ${instances}
            instance = trim ${instance}
            if not is_empty ${instance}
                info "ğŸ¯ Checking instance: ${instance}"

                supervisor_workers_config_folder_exists = is_path_exists ${SUPERVISOR_WORKERS_CONFIG_FOLDER}
                workers = array
                if ${supervisor_workers_config_folder_exists}
                    supervisor_workers = exec --fail-on-error python -c "import os, sys; path = sys.argv[1]; print('\\n'.join(sorted(name for name in os.listdir(path) if os.path.isdir(os.path.join(path, name)))))" ${SUPERVISOR_WORKERS_CONFIG_FOLDER}
                    supervisor_workers = trim ${supervisor_workers.stdout}
                    supervisor_workers = split ${supervisor_workers} "\n"
                    for supervisor_worker in ${supervisor_workers}
                        supervisor_worker = trim ${supervisor_worker}
                        if not is_empty ${supervisor_worker}
                            debug "ğŸ“ Selecting worker: ${supervisor_worker}"
                            array_push ${workers} ${supervisor_worker}
                        end
                    end
                else
                    warn "âš ï¸ Supervisor regular workers config folder not found: ${SUPERVISOR_WORKERS_CONFIG_FOLDER}"
                end
                workers_list = array_join ${workers} ", "
                if is_empty ${workers_list}
                    debug "â“ No regular supervisor workers configured under ${SUPERVISOR_WORKERS_CONFIG_FOLDER}"
                else
                    debug "ğŸŒ€ Supervisor workers to check: ${workers_list}"
                end

                debug "ğŸš€ ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} status --instance ${instance}"

                status_timeout = calc 5 * 60
                status_sleep = set 10000
                status_attempts = calc ${status_timeout} * 1000
                status_attempts = calc ${status_attempts} / ${status_sleep}

                status_attempt = set 0
                status_checking = set true

                while ${status_checking}
                    output_timestamp = exec --fail-on-error python -c "from datetime import datetime; print(datetime.now().isoformat())"
                    current_timestamp = trim ${output_timestamp.stdout}
                    info "â˜•ï¸ (${current_timestamp}) Checking workers..."

                    output = exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} status --instance ${instance}

                    workers_started = set true
                    stopped_workers = array
                    for worker in ${workers}
                        worker = trim ${worker}
                        if not is_empty ${worker}
                            info "ğŸ”… Checking worker: ${worker}"
                            worker_started = contains ${output.stdout} ${worker}
                            if not ${worker_started}
                                info "   ğŸ”´ Worker ${worker} is not running"
                                workers_started = set false
                                array_push ${stopped_workers} ${worker}
                            else
                                info "   ğŸŸ¢ Worker ${worker} is running"
                            end
                        end
                    end

                    if ${workers_started}
                        if is_empty ${workers_list}
                            info "ğŸš¦ Verified supervisor is running"
                        else
                            info "ğŸš¦ Verified supervisor & (${workers_list}) are running"
                        end
                        status_checking = set false
                    else
                        stopped_workers_list = array_join ${stopped_workers} ", "
                        debug ". ${status_attempt}"
                        if not is_empty ${stopped_workers_list}
                            debug "ğŸ‘€ Waiting for workers: ${stopped_workers_list}"
                        end
                        status_attempt = calc ${status_attempt} + 1
                        status_exhausted = eq ${status_attempt} ${status_attempts}
                        if ${status_exhausted}
                            error "ğŸ˜¡ Cancelling execution as supervisor did not start after ${status_timeout} seconds"
                            error "ğŸ›ğŸ‘€ Supervisor status >>>>>"
                            error "ğŸ›ğŸ‘€ <out.i>"
                            error "${output.stdout}"
                            error "ğŸ›ğŸ‘€ <out.f>"
                            error "ğŸ›ğŸ‘€ <err.i>"
                            error "${output.stderr}"
                            error "ğŸ›ğŸ‘€ <err.f>"
                            error "ğŸ›ğŸ‘€ <code.i>"
                            error "${output.code}"
                            error "ğŸ›ğŸ‘€ <code.f>"
                            error "ğŸ›ğŸ‘€ <<<<<"
                            assert_fail
                        end
                        sleep ${status_sleep}
                    end
                end
            end
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata status."
    end

    cm_run_task __os__ps_pytest_tabsdata_servers
    ''']

[tasks.__os__stop_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Stopping tabsdata testing servers..."

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"

        instances = exec --fail-on-error python ${TESTING_INSTANCES_SCRIPT} ${TESTING_SUPERVISORS_CONFIG}
        instances = split ${instances.stdout} "\n"

        for instance in ${instances}
            instance = trim ${instance}
            if not is_empty ${instance}
                info "ğŸ”… Stopping instance: ${instance}"

                debug "ğŸš€ ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance ${instance}"

                on_ga = get_env TD_ON_GA
                on_ga_true = eq ${on_ga} "true"

                if ${on_ga_true}
                    exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance ${instance}
                else
                    output = exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance ${instance}
                end
            end
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata status."
    end

    cm_run_task __os__ps_pytest_tabsdata_servers
    ''']

[tasks.__os__drop_pytest_tabsdata_servers]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Deleteing tabsdata testing servers..."

    home_folder = set ${HOME}

    instances = exec --fail-on-error python ${TESTING_INSTANCES_SCRIPT} ${TESTING_SUPERVISORS_CONFIG}
    instances = split ${instances.stdout} "\n"

    for instance in ${instances}
        instance = trim ${instance}
        if not is_empty ${instance}
            info "ğŸ”… Droping instance: ${instance}"

            instance_folder = set ${home_folder}/.tabsdata/instances/${instance}
            debug "âœ… The tabsdata instance ${instance} folder is: ${instance_folder}"
            exists_instance_folder = is_path_exists ${instance_folder}
            if eq ${exists_instance_folder} true
                debug "âœ… The tabsdata instance ${instance} folder exists. Deleting it: ${target_dir}..."
                rm -r ${instance_folder}
                debug "âœ… The tabsdata instance ${instance} has been deleted: ${target_dir}!"
            else
                debug "âœ… The tabsdata instance ${instance} folder does not exist. Skipping deleting it: ${target_dir}."
            end
        end
    end
    ''']
