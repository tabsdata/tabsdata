#
# Copyright 2025 Tabs Data Inc.
#

[tasks.__os__start_pytest_tabsdata_server]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Starting tabsdata server (pytest)..."

    trace "ğŸ› ğŸ”´ Process list >>>>>"
    processes = exec python -c "import psutil; [print(f'{pi[\"pid\"]:>6} {pi[\"ppid\"]:>6} {pi.get(\"username\",\"?\"):>10} ' + ' '.join(pi['cmdline'] or [pi['name']])) for pi in (p.info for p in psutil.process_iter(['pid','ppid','username','name','cmdline']))]"
    processes = trim ${processes.stdout}
    trace "${processes}"
    trace "ğŸ› ğŸ”´ <<<<<"

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"

        forward_arguments = array
        array_push ${forward_arguments} ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
        array_push ${forward_arguments} start
        array_push ${forward_arguments} --instance
        array_push ${forward_arguments} pytest
        array_push ${forward_arguments} --

        yaml_path = set "./variant/config/pytest/supervisor.yaml"
        debug "ğŸ”… Processing supervisor configuration override from: '${yaml_path}'"

        yaml_content = exec --fail-on-error python make/make-os/libraries/yml.py ${yaml_path}
        yaml_content = trim ${yaml_content.stdout}
        debug "ğŸ”… Output of yaml parser:\n ${yaml_content}"

        yaml_lines = split ${yaml_content.stdout} "\n"
        for yaml_line in ${yaml_lines}
            yaml_line = trim ${yaml_line}
            is_yaml_line_empty = is_empty ${yaml_line}
            if not ${is_yaml_line_empty}
                array_push ${forward_arguments} ${yaml_line}
            end
        end
        command = array_join ${forward_arguments} " "

        debug "ğŸš€ ${command}"

        on_ga = get_env TD_ON_GA
        on_ga_true = eq ${on_ga} "true"
        os = os_family
        if eq ${os} "windows"
            exec --fail-on-error %{command}
        else
            if ${on_ga_true}
                exec --fail-on-error %{command}
            else
                output = exec --fail-on-error %{command}
            end
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata start."
    end

    trace "ğŸ› ğŸŸ¢ Process list >>>>>"
    processes = exec python -c "import psutil; [print(f'{pi[\"pid\"]:>6} {pi[\"ppid\"]:>6} {pi.get(\"username\",\"?\"):>10} ' + ' '.join(pi['cmdline'] or [pi['name']])) for pi in (p.info for p in psutil.process_iter(['pid','ppid','username','name','cmdline']))]"
    processes = trim ${processes.stdout}
    trace "${processes}"
    trace "ğŸ› ğŸŸ¢ <<<<<"
    ''']

[tasks.__os__status_pytest_tabsdata_server]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Checking status of tabsdata server (pytest)..."

    trace "ğŸ› ğŸ”´ Process list >>>>>"
    processes = exec python -c "import psutil; [print(f'{pi[\"pid\"]:>6} {pi[\"ppid\"]:>6} {pi.get(\"username\",\"?\"):>10} ' + ' '.join(pi['cmdline'] or [pi['name']])) for pi in (p.info for p in psutil.process_iter(['pid','ppid','username','name','cmdline']))]"
    processes = trim ${processes.stdout}
    trace "${processes}"
    trace "ğŸ› ğŸ”´ <<<<<"

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"
        debug "ğŸš€ ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} status --instance pytest"

        status_timeout = calc 3 * 60
        status_sleep = set 1000
        status_attempts = calc ${status_timeout} * 1000
        status_attempts = calc ${status_attempts} / ${status_sleep}

        status_attempt = set 0
        status_running = set true

        while ${status_running}
            trace "ğŸ› ğŸ”´ Process list >>>>>"
            processes = exec python -c "import psutil; [print(f'{pi[\"pid\"]:>6} {pi[\"ppid\"]:>6} {pi.get(\"username\",\"?\"):>10} ' + ' '.join(pi['cmdline'] or [pi['name']])) for pi in (p.info for p in psutil.process_iter(['pid','ppid','username','name','cmdline']))]"
            processes = trim ${processes.stdout}
            trace "${processes}"
            trace "ğŸ› ğŸ”´ <<<<<"

            output = exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} status --instance pytest

            trace "ğŸ›ğŸ‘€ Supervisor status >>>>>"
            trace "ğŸ›ğŸ‘€ <out.i>"
            trace "${output.stdout}"
            trace "ğŸ›ğŸ‘€ <out.f>"
            trace "ğŸ›ğŸ‘€ <err.i>"
            trace "${output.stderr}"
            trace "ğŸ›ğŸ‘€ <err.f>"
            trace "ğŸ›ğŸ‘€ <code.i>"
            trace "${output.code}"
            trace "ğŸ›ğŸ‘€ <code.f>"
            trace "ğŸ›ğŸ‘€ <<<<<"

            status_started = contains ${output.stdout} "apiserver"
            if ${status_started}
                debug "ğŸ”… Verified supervisor & apiserver are running"
                status_running = set false
            else
                debug ". ${status_attempt}"
                status_attempt = calc ${status_attempt} + 1
                status_exhausted = eq ${status_attempt} ${status_attempts}
                if ${status_exhausted}
                    error "ğŸ˜¡ Cancelling execution as supervisor did not start after ${status_timeout} seconds"
                    exit 1
                end
                sleep ${status_sleep}
            end
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata status."
    end

    trace "ğŸ› ğŸŸ¢ Process list >>>>>"
    processes = exec python -c "import psutil; [print(f'{pi[\"pid\"]:>6} {pi[\"ppid\"]:>6} {pi.get(\"username\",\"?\"):>10} ' + ' '.join(pi['cmdline'] or [pi['name']])) for pi in (p.info for p in psutil.process_iter(['pid','ppid','username','name','cmdline']))]"
    processes = trim ${processes.stdout}
    trace "${processes}"
    trace "ğŸ› ğŸŸ¢ <<<<<"
    ''']

[tasks.__os__stop_pytest_tabsdata_server]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Stopping tabsdata server (pytest)..."

    trace "ğŸ› ğŸ”´ Process list >>>>>"
    processes = exec python -c "import psutil; [print(f'{pi[\"pid\"]:>6} {pi[\"ppid\"]:>6} {pi.get(\"username\",\"?\"):>10} ' + ' '.join(pi['cmdline'] or [pi['name']])) for pi in (p.info for p in psutil.process_iter(['pid','ppid','username','name','cmdline']))]"
    processes = trim ${processes.stdout}
    trace "${processes}"
    trace "ğŸ› ğŸ”´ <<<<<"

    if is_empty ${profile}
        build-folder = set "debug"
    else
        is_dev = eq ${profile} "dev"
        if ${is_dev}
            build-folder = set "debug"
        else
            build-folder = set ${profile}
        end
    end
    if not is_empty ${td-target}
        build-folder = set ${td-target}/${build-folder}
    end
    debug "ğŸ”… Using build folder ${build-folder}"
    os_family = os_family
    if eq ${os_family} "windows"
        tdserver = set "tdserver.exe"
    else
        tdserver = set "tdserver"
    end

    exists = is_path_exists ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver}
    if ${exists}
        debug "ğŸ”… Using tdserver binary: '${os_family}' - '${tdserver}'"
        debug "ğŸš€ ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance pytest"

        on_ga = get_env TD_ON_GA
        on_ga_true = eq ${on_ga} "true"

        if ${on_ga_true}
            exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance pytest
        else
            output = exec --fail-on-error ${PROJECT_TABSDATA_ROOT_FOLDER}/target/${build-folder}/${tdserver} stop --instance pytest
        end
    else
        warn "ğŸšš Binaries for tdserver not available. Skipping tabsdata status."
    end

    trace "ğŸ› ğŸŸ¢ Process list >>>>>"
    processes = exec python -c "import psutil; [print(f'{pi[\"pid\"]:>6} {pi[\"ppid\"]:>6} {pi.get(\"username\",\"?\"):>10} ' + ' '.join(pi['cmdline'] or [pi['name']])) for pi in (p.info for p in psutil.process_iter(['pid','ppid','username','name','cmdline']))]"
    processes = trim ${processes.stdout}
    trace "${processes}"
    trace "ğŸ› ğŸŸ¢ <<<<<"
    ''']

[tasks.__os__drop_pytest_tabsdata_server]
plugin = "td-task-tracker"
category = "04 - Test"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    debug "ğŸ”· _____ Deleteing tabsdata server (pytest)..."

    home_folder = set ${HOME}
    instance_folder = set ${home_folder}/.tabsdata/instances/pytest
    debug "âœ… The tabsdata instance pytest folder is: ${instance_folder}"
    exists_instance_folder = is_path_exists ${instance_folder}
    if eq ${exists_instance_folder} true
        debug "âœ… The tabsdata instance pytest folder exists. Deleting it: ${target_dir}..."
        rm -r ${instance_folder}
        debug "âœ… The tabsdata instance pytest has been deleted: ${target_dir}!"
    else
        debug "âœ… The tabsdata instance pytest folder does not exist. Skipping deleting it: ${target_dir}."
    end
    ''']
