#
# Copyright 2025 Tabs Data Inc.
#

[tasks.__os__permit_rs]
plugin = "td-task-tracker"
category = "80 - Verify"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    tabsdata_rust_version = set 1.89.0
    set_env TABSDATA_RUST_VERSION ${tabsdata_rust_version}

    info "â™»ï¸ï¸ Checking if the required Rust version is installed..."

    rustc = which rustc
    if equals ${rustc} ""
        error "ğŸš«ğŸš«ğŸš«ğŸš«ğŸš« Rust is not available. Make aborted."
        assert_fail
    end

    result = exec rustc --version
    code = set ${result.code}
    if not equals ${code} "0"
        error "ğŸš«ğŸš«ğŸš«ğŸš«ğŸš« Rust is available but unusable. Make aborted."
        assert_fail
    end

    version = trim ${result.stdout}
    info "â‡ï¸ Rust version: ${version}"

    result = exec python -c "import os, sys, subprocess; v = tuple(map(int, os.environ['TABSDATA_RUST_VERSION'].split('.'))); r = subprocess.check_output(['rustc', '--version']).decode().split()[1]; rv = tuple(map(int, r.split('.'))); sys.exit(0 if rv >= v else 1)"
    code = set ${result.code}
    if not equals ${code} "0"
        error "ğŸš«ğŸš«ğŸš«ğŸš«ğŸš« The Rust version is lesser than requited Rust version < ${tabsdata_rust_version} >. Make aborted."
        assert_fail
    end

    components_array = array
    array_push ${components_array} "clippy"
    array_push ${components_array} "rustfmt"
    components = array_join ${components_array} " "

    crates_array = array
    array_push ${crates_array} "cargo-audit"
    array_push ${crates_array} "cargo-deny"
    array_push ${crates_array} "cargo-edit"
    array_push ${crates_array} "cargo-license"
    array_push ${crates_array} "cargo-machete"
    array_push ${crates_array} "cargo-make"
    array_push ${crates_array} "cargo-nextest"
    array_push ${crates_array} "cargo-outdated"
    array_push ${crates_array} "cargo-pants"
    array_push ${crates_array} "cargo-update"
    array_push ${crates_array} "cargo-upgrades"
    array_push ${crates_array} "cargo-workspaces"
    array_push ${crates_array} "cross"
    array_push ${crates_array} "mdbook"
    crates = array_join ${crates_array} " "

    exec --fail-on-error rustup component add %{components}
    exec --fail-on-error cargo install --quiet --jobs 8 %{crates}
    ''']
