#
# Copyright 2025 Tabs Data Inc.
#

[tasks.__os__build_py_ta_features]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__build_py_ta_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__build_py_te_examples]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    cd "${PROJECT_PY_TE_EXAMPLES_FOLDER}/tabsdata/extensions/_examples/guides"

    debug "üöÄ mdbook build"
    exec --fail-on-error mdbook build
    ''']

[tasks.__os__build_py_te_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__build_py_ty_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__build_py_tabsdata]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__build_py_connectors]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    connectors = glob_array ${OS_CONNECTORS_PY_ROOT_FOLDER}/tabsdata_*

    for connector in ${connectors}
        is_connector = is_dir ${connector}
            warn "‚è≥ Nothing to do: ${connector}."
        if ${is_connector}
        end
    end
    ''']

[tasks.__os__link_py]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__egg_py]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
description = "Task 'egg' for Python projects"
run_task = [
    { name = [
        "__os__egg_py_ta_features",
        "__os__egg_py_ta_tableframe",
        "__os__egg_py_te_examples",
        "__os__egg_py_te_tableframe",
        "__os__egg_py_ty_tableframe",
        "__os__egg_py_tabsdata",
        "__os__egg_py_connectors",
    ] }
]

[tasks.__os__egg_py_ta_features]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__egg_py_ta_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__egg_py_te_examples]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__egg_py_te_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__egg_py_ty_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "‚è≥ Nothing to do."
    ''']

[tasks.__os__egg_py_tabsdata]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    set_env PYTHONWARNINGS ignore

    debug "üî∑ üî∑ _____ Setting up tabsdata pytest context (tabsdata)..."

    cd ${PROJECT_TABSDATA_ROOT_FOLDER}

    # Prevent make from using the local system scripts generated by setup.py

    # debug "üöÄ python setup.py --quiet develop --script-dir target/pytest/build"
    # exec --fail-on-error python setup.py --quiet develop --script-dir target/pytest/build

    debug "üöÄ uv pip install --quiet -e ."
    output = exec --fail-on-error uv pip install --quiet -e .

    python_output = exec python -c "import sys; print(sys.prefix + '/bin')"
    python_bin_dir = set ${python_output.stdout}
    python_bin_dir = trim ${python_bin_dir}
    mkdir target/pytest/build
    entry_points_file = set "./target/python/egg/tabsdata.egg-info/entry_points.txt"
    if is_path_exists ${entry_points_file}
        entry_points_content = readfile ${entry_points_file}
        entry_points_lines = split ${entry_points_content} "\n"
        in_console_scripts = set false
        for entry_points_line in ${entry_points_lines}
            entry_points_line = trim ${entry_points_line}
            if eq ${entry_points_line} "[console_scripts]"
                in_console_scripts = set true
            elif starts_with ${entry_points_line} "["
                in_console_scripts = set false
            else
                is_entry_points_line_empty = is_empty ${entry_points_line}
                is_entry_points_line_not_empty = not ${is_entry_points_line_empty}
                if ${in_console_scripts} and ${is_entry_points_line_not_empty}
                    script_parts = split ${entry_points_line} "="
                    script_parts_length = array_length ${script_parts}
                    if greater_than ${script_parts_length} 0
                        script_name = array_get ${script_parts} 0
                        script_name = trim ${script_name}
                        source_script = set "${python_bin_dir}/${script_name}"
                        target_script = set "target/pytest/build/${script_name}"
                        if is_path_exists ${source_script}
                            cp ${source_script} ${target_script}
                        end
                    end
                end
            end
        end
    end

    # Prevent make from using the local system scripts generated by pip
    rm target/pytest/build/pip
    rm target/pytest/build/pip.exe
    rm target/pytest/build/pip3
    rm target/pytest/build/pip3.exe
    rm target/pytest/build/wheel
    rm target/pytest/build/wheel.exe
    ''']

[tasks.__os__egg_py_connectors]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    set_env PYTHONWARNINGS ignore

    cd ${PROJECT_TABSDATA_ROOT_FOLDER}

    connectors = glob_array ${OS_CONNECTORS_PY_ROOT_FOLDER}/tabsdata_*

    for connector in ${connectors}
        is_connector = is_dir ${connector}
        if ${is_connector}
            connector_name = basename ${connector}

            debug "üî∑ üî∑ _____ Setting up tabsdata pytest context (${connector_name})..."

            cd ${connector}

            # Prevent make from using the local system scripts generated by setup.py

            debug "üöÄ python setup.py --quiet develop --script-dir target/pytest/build"
            exec --fail-on-error python setup.py --quiet develop --script-dir target/pytest/build

            # Prevent make from using the local system scripts generated by setup.py
            rm target/pytest/build/pip
            rm target/pytest/build/pip.exe
            rm target/pytest/build/pip3
            rm target/pytest/build/pip3.exe
            rm target/pytest/build/wheel
            rm target/pytest/build/wheel.exe

            cd ${PROJECT_TABSDATA_ROOT_FOLDER}
        end
    end
    ''']
