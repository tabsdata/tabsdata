#
# Copyright 2025 Tabs Data Inc.
#

[tasks.__os__build_py_ta_features]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__build_py_ta_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__build_py_te_examples]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    cd "${PROJECT_PY_TE_EXAMPLES_FOLDER}/tabsdata/extensions/_examples/guides"

    debug "ğŸš€ mdbook build"
    exec --fail-on-error mdbook build
    ''']

[tasks.__os__build_py_te_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__build_py_ty_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__build_py_tabsdata]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__build_py_connectors]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    connectors = glob_array ${OS_CONNECTORS_PY_ROOT_FOLDER}/tabsdata_*

    for connector in ${connectors}
        is_connector = is_dir ${connector}
            warn "â³ Nothing to do: ${connector}."
        if ${is_connector}
        end
    end
    ''']

[tasks.__os__link_py]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__egg_py]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
description = "Task 'egg' for Python projects"
run_task = [
    { name = [
        "__os__egg_py_ta_features",
        "__os__egg_py_ta_tableframe",
        "__os__egg_py_te_examples",
        "__os__egg_py_te_tableframe",
        "__os__egg_py_ty_tableframe",
        "__os__egg_py_tabsdata",
        "__os__egg_py_connectors",
    ] }
]

[tasks.__os__egg_py_ta_features]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__egg_py_ta_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__egg_py_te_examples]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__egg_py_te_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__egg_py_ty_tableframe]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    warn "â³ Nothing to do."
    ''']

[tasks.__os__egg_py_tabsdata]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    set_env PYTHONWARNINGS ignore

    debug "ğŸ”· ğŸ”· _____ Setting up tabsdata pytest context (tabsdata)..."

    on_ga = get_env TD_ON_GA
    on_ga_true = eq ${on_ga} "true"

    cd ${PROJECT_TABSDATA_ROOT_FOLDER}

    # Prevent make from using the local system scripts generated by setup.py

    # debug "ğŸš€ python setup.py --quiet develop --script-dir target/pytest/build"
    # exec --fail-on-error python setup.py --quiet develop --script-dir target/pytest/build

    trace "ğŸ”¸ğŸ”¸ğŸ”¸ Environment variable PROJECT_TABSDATA_ROOT_FOLDER: ${PROJECT_TABSDATA_ROOT_FOLDER}"

    uv_version = exec uv --version
    uv_version = trim ${uv_version.stdout}
    debug "ï¸ğŸ”¸ğŸ”¸ğŸ”¸ Version of uv: ${uv_version}"

    python_version = exec python --version
    python_version = trim ${python_version.stdout}
    debug "ï¸ğŸ”¸ğŸ”¸ğŸ”¸ Version of python: ${python_version}"

    virtual_env = get_env VIRTUAL_ENV
    debug "ï¸ğŸ”¸ğŸ”¸ğŸ”¸ Environment variable VIRTUAL_ENV: ${virtual_env}"

    if is_empty ${virtual_env}
        if ${on_ga_true}
            debug "ğŸš€ uv pip install --system -e ."
            exec --fail-on-error uv pip install --system -e .
        else
            debug "ğŸš€ uv pip install --quiet -e ."
            exec --fail-on-error uv pip install --quiet -e .
        end
    else
        if ${on_ga_true}
            debug "ğŸš€ uv pip install -e ."
            exec --fail-on-error uv pip install -e .
        else
            debug "ğŸš€ uv pip install --quiet -e ."
            exec --fail-on-error uv pip install --quiet -e .
        end
    end

    python_scripts_folder = exec python -c "import sysconfig; print(sysconfig.get_path('scripts'))"
    python_scripts_folder = trim ${python_scripts_folder.stdout}
    trace "ğŸ”¸ğŸ”¸ğŸ”¸ Value of python_scripts_folder is ${python_scripts_folder}"

    mkdir target/pytest/build

    current_folder = pwd
    trace "ğŸ”¸ğŸ”¸ğŸ”¸ Current folder: ${current_folder.stdout}"

    target_python = exec python -c "from pathlib import Path; print(Path('.').resolve())"
    target_python = trim  ${target_python.stdout}
    trace "ğŸ”¸ğŸ”¸ğŸ”¸ Folder ./target/python resolves to: ${target_python}"

    trace "ğŸ”¸ğŸ”¸ğŸ”¸ Contents of ./target/python >>>>>"
    target_python_tree = exec python -c "import os; [print(root) or [print(f'  {name}') for name in files+folders] for root, folders, files in os.walk('target/python')]"
    target_python_tree = trim ${target_python_tree.stdout}
    debug "${target_python_tree}"
    trace "ğŸ”¸ğŸ”¸ğŸ”¸ <<<<<"

    entry_points_file = set "./target/python/egg/tabsdata.egg-info/entry_points.txt"
    if is_path_exists ${entry_points_file}
        trace "ğŸ”¸ğŸ”¸ğŸ”¸ The expected file ./target/python/egg/tabsdata.egg-info/entry_points.txt does exist."

        entry_points_content = readfile ${entry_points_file}

        trace "ğŸ”¸ğŸ”¸ğŸ”¸ The contets of file ./target/python/egg/tabsdata.egg-info/entry_points.txt is >>>>>"
        debug "${entry_points_content}"
        trace "ğŸ”¸ğŸ”¸ğŸ”¸ <<<<<"

        entry_points_lines = split ${entry_points_content} "\n"
        in_console_scripts = set false
        for entry_points_line in ${entry_points_lines}
            entry_points_line = trim ${entry_points_line}
            if eq ${entry_points_line} "[console_scripts]"
                in_console_scripts = set true
            elif starts_with ${entry_points_line} "["
                in_console_scripts = set false
            else
                is_entry_points_line_empty = is_empty ${entry_points_line}
                is_entry_points_line_not_empty = not ${is_entry_points_line_empty}
                if ${in_console_scripts} and ${is_entry_points_line_not_empty}
                    script_parts = split ${entry_points_line} "="
                    script_parts_length = array_length ${script_parts}
                    if greater_than ${script_parts_length} 0
                        script_name = array_get ${script_parts} 0
                        script_name = trim ${script_name}
                        source_script = set "${python_scripts_folder}/${script_name}"
                        target_script = set "target/pytest/build/${script_name}"
                        if is_path_exists ${source_script}
                            cp ${source_script} ${target_script}
                        end
                    end
                end
            end
        end
    else
        trace "ğŸ”¸ğŸ”¸ğŸ”¸ The expected file ./target/python/egg/tabsdata.egg-info/entry_points.txt does not exist."
    end

    # Prevent make from using the local system scripts generated by pip
    rm target/pytest/build/pip
    rm target/pytest/build/pip.exe
    rm target/pytest/build/pip3
    rm target/pytest/build/pip3.exe
    rm target/pytest/build/wheel
    rm target/pytest/build/wheel.exe
    ''']

[tasks.__os__egg_py_connectors]
plugin = "td-task-tracker"
category = "03 - Build"
private = true
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    set_env PYTHONWARNINGS ignore

    cd ${PROJECT_TABSDATA_ROOT_FOLDER}

    connectors = glob_array ${OS_CONNECTORS_PY_ROOT_FOLDER}/tabsdata_*

    for connector in ${connectors}
        is_connector = is_dir ${connector}
        if ${is_connector}
            connector_name = basename ${connector}

            debug "ğŸ”· ğŸ”· _____ Setting up tabsdata pytest context (${connector_name})..."

            cd ${connector}

            # Prevent make from using the local system scripts generated by setup.py

            debug "ğŸš€ python setup.py --quiet develop --script-dir target/pytest/build"
            exec --fail-on-error python setup.py --quiet develop --script-dir target/pytest/build

            # Prevent make from using the local system scripts generated by setup.py
            rm target/pytest/build/pip
            rm target/pytest/build/pip.exe
            rm target/pytest/build/pip3
            rm target/pytest/build/pip3.exe
            rm target/pytest/build/wheel
            rm target/pytest/build/wheel.exe

            cd ${PROJECT_TABSDATA_ROOT_FOLDER}
        end
    end
    ''']
