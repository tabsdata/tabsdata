#
# Copyright 2025 Tabs Data Inc.
#

[tasks.__os__audit_py]
plugin = "td-task-tracker"
category = "07 - Shield"
private = true
cwd = "${PROJECT_TABSDATA_ROOT_FOLDER}"
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds
    !include_files ./make/make-os/libraries/file.ds

    exec --fail-on-error python -m pip install --upgrade "pip==25.2"

    requirements-third-party-all-path = temp_file txt
    info "ðŸŒ¤  Using temporary file at ${requirements-third-party-all-path} for requirements-third-party-all.txt"
    info "ðŸš€ uv pip compile --format requirements.txt --quiet --output-file ${requirements-third-party-all-path} ./requirements/requirements-third-party-all.txt"
    exec --fail-on-error uv pip compile --format requirements.txt --quiet --output-file ${requirements-third-party-all-path} ./requirements/requirements-third-party-all.txt

    file_is_empty = is_file_empty ${requirements-third-party-all-path}
    if ${file_is_empty}
        warn "ðŸª¹ File ${requirements-third-party-all-path} contains no requirement. Skipping audit on it."
    else
        debug "ðŸš€ pysentry-rs --severity low --fail-on low --ignore PYSEC-2022-42969 --ignore GHSA-4xh5-x5gv-qwph --no-cache --sources pypa,osv,pypi --resolver uv --verbose --detailed --requirements-files ${requirements-third-party-all-path}"
        exec --fail-on-error pysentry-rs --severity low --fail-on low --ignore PYSEC-2022-42969 --ignore GHSA-4xh5-x5gv-qwph --no-cache --sources pypa,osv,pypi --resolver uv --verbose --detailed --requirements-files ${requirements-third-party-all-path}

        debug "ðŸš€ pysentry-rs --severity low --fail-on low --ignore PYSEC-2022-42969 --ignore GHSA-4xh5-x5gv-qwph --no-cache --sources pypa,osv,pypi --resolver pip-tools --verbose --detailed --requirements-files ${requirements-third-party-all-path}"
        exec --fail-on-error pysentry-rs --severity low --fail-on low --ignore PYSEC-2022-42969 --ignore GHSA-4xh5-x5gv-qwph --no-cache --sources pypa,osv,pypi --resolver pip-tools --verbose --detailed --requirements-files ${requirements-third-party-all-path}
    end

    requirements-dev-third-party-path = temp_file txt
    info "ðŸŒ¦  Using temporary file at ${requirements-dev-third-party-path} for requirements-dev-third-party.txt"
    info "ðŸš€ uv pip compile --format requirements.txt --quiet --output-file ${requirements-dev-third-party-path} ./requirements/requirements-dev-third-party.txt"
    exec --fail-on-error uv pip compile --format requirements.txt --quiet --output-file ${requirements-dev-third-party-path} ./requirements/requirements-dev-third-party.txt

    file_is_empty = is_file_empty ${requirements-dev-third-party-path}
    if ${file_is_empty}
        warn "ðŸª¹ File ${requirements-dev-third-party-path} contains no requirement. Skipping audit on it."
    else
        debug "ðŸš€ pysentry-rs --severity low --fail-on low --ignore PYSEC-2022-42969 --ignore GHSA-4xh5-x5gv-qwph --no-cache --sources pypa,osv,pypi --resolver uv --verbose --detailed --requirements-files ${requirements-dev-third-party-path}"
        exec --fail-on-error pysentry-rs --severity low --fail-on low --ignore PYSEC-2022-42969 --ignore GHSA-4xh5-x5gv-qwph --no-cache --sources pypa,osv,pypi --resolver uv --verbose --detailed --requirements-files ${requirements-dev-third-party-path}

        debug "ðŸš€ pysentry-rs --severity low --fail-on low --ignore PYSEC-2022-42969 --ignore GHSA-4xh5-x5gv-qwph --no-cache --sources pypa,osv,pypi --resolver pip-tools --verbose --detailed --requirements-files ${requirements-dev-third-party-path}"
        exec --fail-on-error pysentry-rs --severity low --fail-on low --ignore PYSEC-2022-42969 --ignore GHSA-4xh5-x5gv-qwph --no-cache --sources pypa,osv,pypi --resolver pip-tools --verbose --detailed --requirements-files ${requirements-dev-third-party-path}
    end

    exec --fail-on-error python -m pip install --upgrade pip

    # debug "ðŸš€ pip-audit --progress-spinner on --strict --requirement requirements/requirements-third-party-all.txt --ignore-vuln PYSEC-2022-42969"
    # exec --fail-on-error pip-audit --progress-spinner on --strict --requirement requirements/requirements-third-party-all.txt --ignore-vuln PYSEC-2022-42969

    # debug "ðŸš€ pip-audit --progress-spinner on --strict --requirement requirements/requirements-dev-third-party.txt --ignore-vuln PYSEC-2022-42969"
    # exec --fail-on-error pip-audit --progress-spinner on --strict --requirement requirements/requirements-dev-third-party.txt --ignore-vuln PYSEC-2022-42969
    ''']

