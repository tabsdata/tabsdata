#
# Copyright 2025 Tabs Data Inc.
#

[tasks.start]
plugin = "td-task-tracker"
category = "90 - Lifecycle"
description = "Handle make tasks start"
private = false
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    cm_run_task banner

    project_tabsdata_root_folder = get_env PROJECT_TABSDATA_ROOT_FOLDER
    ko = starts_with ${project_tabsdata_root_folder} "\${"
    if ${ko}
        exit 0
    end

    info "ğŸ¢ Runnning task: ${CARGO_MAKE_TASK}"

    os = os_family
    debug "ğŸˆ Current os: ${os}"
    if eq ${os} "windows"
        temp = temp_dir
        marker = join_path ${temp} .td.make
        exists = is_path_exists ${marker}
        info "ğŸ The marker temp file is ${marker}"
        if ${exists}
            info "ğŸ… Marker for make exsits. Skipping setup."
            ok = rm ${marker}
            exit 0
        end
        info "ğŸ Marker for make does not exist. Resuming setup."
        ok = touch ${marker}
    else
        pid = pid
        debug "ğŸ€ Current proces id: ${pid}"
        output = exec ps -o ppid= -p ${pid}
        ppid = trim ${output.stdout}
        debug "ğŸ¥ Parent process id: ${ppid}"
        temp = temp_dir
        pid_marker = join_path ${temp} .td.pid.${pid}
        ppid_marker = join_path ${temp} .td.pid.${ppid}
        debug "ğŸŠ The pid temp file is ${pid_marker}"
        debug "ğŸ‹ The ppid temp file is ${ppid_marker}"
        exists = is_path_exists ${pid_marker}
        if ${exists}
            info "ğŸ… Marker for pid exsits. Skipping setup."
            ok = rm ${marker}
            exit 0
        end
        debug "ğŸ Marker for pid does not exist. Resuming setup."
        ok = touch ${ppid_marker}
    end

    echo ""
    user_home = get_env HOME
    info "ğŸ  User HOME: ${HOME}"
    echo ""

    no_user_home = eq ${user_home} ""
    if ${no_user_home}
        error "ğŸš· Environment variable HOME is not defined. Please set it before running this script."
        error "ğŸš· The USERPROFILE Windows environment variable will not work. Use HOME instead."
        echo ""
        exit 1
    end

    user_home_exists = is_path_exists ${user_home}
    if not ${user_home_exists}
        error "ğŸš· Environment variable HOME points to a non-existing path: ${user_home}"
        echo ""
        exit 1
    end

    user_home_is_dir = is_dir ${user_home}
    if not ${user_home_is_dir}
        error "ğŸš· Environment variable HOME points to a non-folder path: ${user_home}"
        echo ""
        exit 1
    end

    PATH = get_env PATH
    debug "âœ… Real PATH: ${PATH}"

    make_task = get_env CARGO_MAKE_TASK
    if eq ${make_task} "docs"
        noop
    else
        cm_run_task permit
    end

    td_override_build_timestamp = get_env TD_OVERRIDE_BUILD_TIMESTAMP
    if eq ${td_override_build_timestamp} "true"
        td_build_timestamp = current_time
        set_env TD_BUILD_TIMESTAMP ${td_build_timestamp}
        td_build_timestamp = get_env TD_BUILD_TIMESTAMP
        info "ğŸ”© TD_OVERRIDE_BUILD_TIMESTAMP is 'true'. Using 'TD_BUILD_TIMESTAMP': '${td_build_timestamp}'."
    end
    ''']
