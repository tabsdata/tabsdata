#
# Copyright 2025 Tabs Data Inc.
#

extend = [
    { path = "./make/make-os/fragments/shared/Maketask.toml", relative = "git" },

    { path = "./make/make-os/fragments/aliases/custom.toml", relative = "git" }
]

[tasks.make]
plugin = "td-task-tracker"
category = "00 - Make"
description = "Full build and verification"
run_task = [
    { name = [
        "make_rs",
        "make_py"
    ] }
]

[tasks.make_rs]
plugin = "td-task-tracker"
category = "00 - Make"
description = "Task 'make' for Rust projects"
run_task = [
    { name = [
        "clean_rs",
        "compose_rs"], condition = { env = { "CLEAN" = "true" } } },
    { name = [
        "compose_rs"
    ] }
]

[tasks.make_py]
plugin = "td-task-tracker"
category = "00 - Make"
description = "Task 'make' for Python projects"
run_task = [
    { name = [
        "clean_py",
        "compose_py"], condition = { env = { "CLEAN" = "true" } } },
    { name = [
        "compose_py"
    ] }
]

[tasks.compose]
plugin = "td-task-tracker"
category = "00 - Make"
description = "Full build and verification orchestration"
private = true
run_task = [
    { name = [
        "compose_rs",
        "compose_py",
    ] }
]

[tasks.compose_rs]
plugin = "td-task-tracker"
category = "00 - Make"
description = "Task 'compose' for Rust projects"
private = true
run_task = [
    { name = [
        "build_rs",
        "test_rs",
        "check_rs",
        "clippy_rs",
        "fmt_rs",
        "license_rs",
        "outdated_rs",
        "machete_rs",
        "audit_rs",
        "deny_rs",
        "pants_rs"
    ] }
]

[tasks.compose_py]
plugin = "td-task-tracker"
category = "00 - Make"
description = "Task 'compose' for Python projects"
private = true
run_task = [
    { name = [
        "build_py",
        "test_py",
        "check_py",
        "clippy_py",
        "fmt_py",
        "license_py",
        "outdated_py",
        "machete_py",
        "audit_py",
        "deny_py",
        "pants_py"
    ] }
]

[tasks.permit]
plugin = "td-task-tracker"
category = "80 - Verify"
description = "Verify that all essential language tools are available"
run_task = [
    { name = [
        "permit_py",
        "permit_rs"
    ] }
]

[tasks.permit_rs]
plugin = "td-task-tracker"
category = "80 - Verify"
description = "Task 'permit' for Rust projects"
run_task = [
    { name = [
        "__os__permit_rs"
    ] }
]

[tasks.permit_py]
plugin = "td-task-tracker"
category = "80 - Verify"
description = "Task 'permit' for Python projects"
run_task = [
    { name = [
        "__os__permit_py"
    ] }
]

[tasks.clean]
plugin = "td-task-tracker"
category = "01 - Clean"
description = "Remove temporary, build, and target folders"
run_task = [
    { name = [
        "clean_rs",
        "clean_py"
    ] }
]

[tasks.clean_rs]
plugin = "td-task-tracker"
category = "01 - Clean"
description = "Task 'clean' for Rust projects"
run_task = [
    { name = [
        "__os__clean_rs_macros",
        "__os__clean_rs_modules",
        "__os__clean_rs_expansions",
        "__os__clean_rs_all"
    ] }
]

[tasks.clean_py]
plugin = "td-task-tracker"
category = "01 - Clean"
description = "Task 'clean' for Python projects"
run_task = [
    { name = [
        "__os__clean_py_ta_features",
        "__os__clean_py_ta_tableframe",
        "__os__clean_py_te_examples",
        "__os__clean_py_te_tableframe",
        "__os__clean_py_ty_tableframe",
        "__os__clean_py_tabsdata",
        "__os__clean_py_connectors",
        "__os__clean_py_all"
    ] }
]

[tasks.bump]
plugin = "td-task-tracker"
category = "02 - Tidy"
description = "Bump the version of all tabsdata projects"
run_task = [
    { name = [
        "__os__bump"
    ] }
]

[tasks.lock]
plugin = "td-task-tracker"
category = "02 - Tidy"
description = "Generate the dependencies lock files"
run_task = [
    { name = [
        "lock_rs",
        "lock_py"
    ] }
]

[tasks.lock_rs]
plugin = "td-task-tracker"
category = "02 - Tidy"
description = "Task 'lock' for Rust projects"
run_task = [
    { name = [
        "__os__lock_rs_macros",
        "__os__lock_rs_modules",
        "__os__lock_rs_expansions"
    ] }
]

[tasks.lock_py]
plugin = "td-task-tracker"
category = "02 - Tidy"
description = "Task 'lock' for Python projects"
run_task = [
    { name = [
        "__os__lock_py_ta_features",
        "__os__lock_py_ta_tableframe",
        "__os__lock_py_te_examples",
        "__os__lock_py_te_tableframe",
        "__os__lock_py_ty_tableframe",
        "__os__lock_py_tabsdata",
        "__os__lock_py_connectors"
    ] }
]

[tasks.sourcetrack]
plugin = "td-task-tracker"
category = "02 - Tidy"
description = "Generate the sourcetrack metadata"
run_task = [
    { name = [
        "__os__generate_sourcetrack"
    ] }
]

[tasks.build]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Compile and build from source code"
run_task = [
    { name = [
        "build_rs",
        "build_py"
    ] }
]

[tasks.build_rs]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'build' for Rust projects"
run_task = [
    { name = [
        "__os__build_all_rs",
        "__os__build_none_rs"], condition = { env = { "TD_BUILD_ALL" = "true" } } },
    { name = [
        "__os__build_none_rs"
    ] }
]

[tasks.build_rs_macros]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'build' for Rust projects (macros)"
run_task = [
    { name = [
        "__os__build_all_rs_macros",
        "__os__build_none_rs_macros"], condition = { env = { "TD_BUILD_ALL" = "true" } } },
    { name = [
        "__os__build_none_rs_macros"
    ] }
]

[tasks.build_rs_tabsdata]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'build' for Rust projects (tabsdata)"
run_task = [
    { name = [
        "__os__build_all_rs_macros",
        "__os__build_none_rs_macros",
        "__os__build_all_rs_modules",
        "__os__build_none_rs_modules"], condition = { env = { "TD_BUILD_ALL" = "true" } } },
    { name = [
        "__os__build_none_rs_macros",
        "__os__build_none_rs_modules"
    ] }
]

[tasks.build_rs_expansions]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'build' for Rust projects (expnasions)"
run_task = [
    { name = [
        "__os__build_all_rs_expansions",
        "__os__build_none_rs_expansions"], condition = { env = { "TD_BUILD_ALL" = "true" } } },
    { name = [
        "__os__build_none_rs_expansions"
    ] }
]

[tasks.build_py]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'build' for Python projects"
run_task = [
    { name = [
        "__os__build_py_ta_features",
        "__os__build_py_ta_tableframe",
        "__os__build_py_te_examples",
        "__os__build_py_te_tableframe",
        "__os__build_py_ty_tableframe",
        "__os__build_py_tabsdata",
        "__os__build_py_connectors"
    ] }
]

[tasks.link]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Generate dynamic libraries from source code"
run_task = [
    { name = [
        "link_rs",
        "link_py"
    ] }
]

[tasks.link_rs]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'link' for Rust projects"
run_task = [
    { name = [
        "__os__link_all_rs",
        "__os__link_none_rs"], condition = { env = { "TD_BUILD_ALL" = "true" } } },
    { name = [
        "__os__link_none_rs"
    ] }
]

[tasks.link_py]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'link' for Python projects"
run_task = [
    { name = [
        "__os__link_py"
    ] }
]

[tasks.egg]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Generate editablue builds from source code"
run_task = [
    { name = [
        "egg_rs",
        "egg_py"
    ] }
]

[tasks.egg_rs]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'egg' for Rust projects"
run_task = [
    { name = [
        "__os__egg_rs"
    ] }
]

[tasks.egg_py]
plugin = "td-task-tracker"
category = "03 - Build"
description = "Task 'build' for Python projects"
run_task = [
    { name = [
        "__os__egg_py_ta_features",
        "__os__egg_py_ta_tableframe",
        "__os__egg_py_te_examples",
        "__os__egg_py_te_tableframe",
        "__os__egg_py_ty_tableframe",
        "__os__egg_py_tabsdata",
        "__os__egg_py_connectors"
    ] }
]

[tasks.test]
plugin = "td-task-tracker"
category = "04 - Test"
description = "Run unit tests"
run_task = [
    { name = [
        "test_rs",
        "test_py"
    ] }
]

[tasks.test_rs]
plugin = "td-task-tracker"
category = "04 - Test"
description = "Task 'test' for Rust projects"
run_task = [
    { name = [
        "__os__setup_test_rs",
        "__os__test_rs_macros",
        "__os__test_rs_modules",
        "__os__test_rs_expansions",
        "__os__cleanup_test_rs"
    ] }
]

[tasks.test_py]
plugin = "td-task-tracker"
category = "04 - Test"
description = "Task 'test' for Python projects"
dependencies = ["__os__set_mode_test_py"]
run_task = [
    { name = [
        "__os__setup_test_py",
        "__os__start_test_py",
        "__os__test_py_ta_features",
        "__os__test_py_ta_tableframe",
        "__os__test_py_te_examples",
        "__os__test_py_te_tableframe",
        "__os__test_py_ty_tableframe",
        "__os__test_py_tabsdata",
        "__os__test_py_connectors",
        "__os__stop_test_py",
        "__os__cleanup_test_py"
    ] }
]

[tasks.outdated]
plugin = "td-task-tracker"
category = "05 - Inspect"
description = "Find outdated dependencies"
run_task = [
    { name = [
        "outdated_rs",
        "outdated_py"
    ] }
]

[tasks.outdated_rs]
plugin = "td-task-tracker"
category = "05 - Inspect"
description = "Task 'outdated' for Rust projects"
run_task = [
    { name = [
        "__os__outdated_rs_macros",
        "__os__outdated_rs_modules",
        "__os__outdated_rs_expansions"
    ] }
]

[tasks.outdated_py]
plugin = "td-task-tracker"
category = "05 - Inspect"
description = "Task 'outdated' for Python projects"
run_task = [
    { name = [
        "__os__outdated_py"
    ] }
]

[tasks.machete]
plugin = "td-task-tracker"
category = "05 - Inspect"
description = "Find unused dependencies"
run_task = [
    { name = [
        "machete_rs",
        "machete_py"
    ] }
]

[tasks.machete_rs]
plugin = "td-task-tracker"
category = "05 - Inspect"
description = "Task 'machete' for Rust projects"
run_task = [
    { name = [
        "__os__machete_rs",
    ] }
]

[tasks.machete_py]
plugin = "td-task-tracker"
category = "05 - Inspect"
description = "Task 'machete' for Python projects"
run_task = [
    { name = [
        "__os__machete_py"
    ] }
]

[tasks.license]
plugin = "td-task-tracker"
category = "06 - Compliance"
description = "Generate the dependencies' license files"
cwd = "${PROJECT_TABSDATA_ROOT_FOLDER}"
dependencies = ["__os__set_mode_license"]
script_runner = "@duckscript"
script = [
    '''
    !include_files ./make/make-os/libraries/log.ds

    license = get_env TD_LICENSE
    if eq ${license} "true"
        cm_run_task license_rs
        cm_run_task license_py
    end

    exec --fail-on-error python ${REPORT_LICENSES_SCRIPT}
    ''']

[tasks.license_rs]
plugin = "td-task-tracker"
category = "06 - Compliance"
description = "Task 'license' for Rust projects"
run_task = [
    { name = [
        "__os__license_check_rs",
        "__os__license_report_rs"
    ] }
]

[tasks.license_py]
plugin = "td-task-tracker"
category = "06 - Compliance"
description = "Task 'license' for Python projects"
run_task = [
    { name = [
        "__os__license_check_py",
        "__os__license_report_py"
    ] }
]

[tasks.audit]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Scan peroject for dependencies with known security vulnerabilities"
run_task = [
    { name = [
        "audit_rs",
        "audit_py"
    ] }
]

[tasks.audit_rs]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Task 'audit' for Rust projects"
run_task = [
    { name = [
        "__os__audit_rs_macros",
        "__os__audit_rs_modules",
        "__os__audit_rs_expansions"
    ] }
]

[tasks.audit_py]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Task 'audit' for Python projects"
run_task = [
    { name = [
        "__os__audit_py"
    ] }
]

[tasks.deny]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Validate code and dependencies for compliance with security and coding conventions"
run_task = [
    { name = [
        "deny_rs",
        "deny_py"
    ] }
]

[tasks.deny_rs]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Task 'deny' for Rust projects"
run_task = [
    { name = [
        "__os__deny_rs_macros",
        "__os__deny_rs_modules",
        "__os__deny_rs_expansions"
    ] }
]

[tasks.deny_py]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Task 'deny' for Python projects"
run_task = [
    { name = [
        "__os__deny_py"
    ] }
]

[tasks.pants]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Scan peroject for dependencies with known security vulnerabilities (cross-language)"
run_task = [
    { name = [
        "pants_rs",
        "pants_py"
    ] }
]

[tasks.pants_rs]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Task 'pants' for Rust projects"
run_task = [
    { name = [
        "__os__pants_rs_macros",
        "__os__pants_rs_modules",
        "__os__pants_rs_expansions"
    ] }
]

[tasks.pants_py]
plugin = "td-task-tracker"
category = "07 - Shield"
description = "Task 'pants' for Python projects"
run_task = [
    { name = [
        "__os__pants_py"
    ] }
]

[tasks.check]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Check projects and dependencies for errors"
run_task = [
    { name = [
        "check_rs",
        "check_py"
    ] }
]

[tasks.check_rs]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Task 'check' for Rust projects"
run_task = [
    { name = [
        "__os__check_rs_macros",
        "__os__check_rs_modules",
        "__os__check_rs_expansions"
    ] }
]

[tasks.check_py]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Task 'check' for Python projects"
run_task = [
    { name = [
        "__os__check_py"
    ] }
]

[tasks.clippy]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Catch common mistakes to improve code quality and correctness"
run_task = [
    { name = [
        "clippy_rs",
        "clippy_py"
    ] }
]

[tasks.clippy_rs]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Task 'clippy' for Rust projects"
run_task = [
    { name = [
        "__os__clippy_rs_macros",
        "__os__clippy_rs_modules",
        "__os__clippy_rs_expansions"
    ] }
]

[tasks.clippy_py]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Task 'clippy' for Python projects"
run_task = [
    { name = [
        "__os__clippy_py"
    ] }
]

[tasks.fmt]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Check code formatting for the whole project"
run_task = [
    { name = [
        "fmt_rs",
        "fmt_py"
    ] }
]

[tasks.fmt_rs]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Task 'fmt' for Rust projects"
run_task = [
    { name = [
        "__os__fmt_rs_macros",
        "__os__fmt_rs_modules",
        "__os__fmt_rs_expansions"
    ] }
]

[tasks.fmt_py]
plugin = "td-task-tracker"
category = "08 - Linter"
description = "Task 'fmt' for Python projects"
run_task = [
    { name = [
        "__os__fmt_py_flake8_conventions",
        "__os__fmt_py_flake8_complexity",
        "__os__fmt_py_black",
        "__os__fmt_py_isort"
    ] }
]

[tasks.format]
plugin = "td-task-tracker"
category = "09 - Repair"
description = "Formats all code using the project's formatting rules"
run_task = [
    { name = [
        "format_rs",
        "format_py"
    ] }
]

[tasks.format_rs]
plugin = "td-task-tracker"
category = "09 - Repair"
description = "Task 'format' for Rust projects"
run_task = [
    { name = [
        "__os__format_rs_macros",
        "__os__format_rs_modules",
        "__os__format_rs_expansions"
    ] }
]

[tasks.format_py]
plugin = "td-task-tracker"
category = "09 - Repair"
description = "Task 'format' for Python projects"
run_task = [
    { name = [
        "__os__format_py_black",
        "__os__format_py_isort"
    ] }
]

[tasks.fix]
plugin = "td-task-tracker"
category = "09 - Repair"
description = "Fix common mistakes to improve code quality and correctness"
run_task = [
    { name = [
        "fix_rs",
        "fix_py"
    ] }
]

[tasks.fix_rs]
plugin = "td-task-tracker"
category = "09 - Repair"
description = "Task 'fix' for Rust projects"
run_task = [
    { name = [
        "__os__fix_rs_macros",
        "__os__fix_rs_modules",
        "__os__fix_rs_expansions"
    ] }
]

[tasks.fix_py]
plugin = "td-task-tracker"
category = "09 - Repair"
description = "Task 'fix' for Python projects"
run_task = [
    { name = [
        "__os__fix_py"
    ] }
]

[tasks.package]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Generate distributable packages from source code"
run_task = [
    { name = [
        "package_rs",
        "package_py"
    ] }
]

[tasks.package_rs]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Task 'package' for Rust projects"
run_task = [
    { name = [
        "__os__package_rs"
    ] }
]

[tasks.package_py]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Task 'package' for Python projects"
run_task = [
    { name = [
        "__os__package_py_tabsdata",
        "__os__package_py_connectors"
    ] }
]

[tasks.assembly]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Generate distributable assebmlies from source code"
dependencies = ["__os__set_mode_assembly"]
run_task = [
    { name = [
        "assembly_rs",
        "assembly_py"], condition = { env = { "TD_ON_GA" = "true" } } },
    { name = [
        "__os__preconditions_assembly",
        "assembly_rs",
        "assembly_py",
        "__os__postconditions_assembly"
    ] }
]

[tasks.assembly_rs]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Task 'assembly' for Rust projects"
run_task = [
    { name = [
        "__os__assembly_rs"
    ] }
]

[tasks.assembly_py]
plugin = "td-task-tracker"
category = "10 - Bundle"
run_task = [
    { name = [
        "license",
        "__os__generate_pydoc_csv",
        "__os__generate_assets",
        "__os__assembly_py_tabsdata",
        "__os__assembly_py_connectors",
    ] }
]

[tasks.wheels_4repo]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Generate wheels for installation using a repository"
run_task = [
    { name = [
        "__os__wheels_4repo_ingest",
        "assembly",
        "__os__wheels_rs",
        "__os__wheels_py",
        "__os__wheels_4repo_digest"
    ] }
]

[tasks.wheels_4whl]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Generate wheels for installation avoiding a repository"
run_task = [
    { name = [
        "__os__wheels_4whl_ingest",
        "assembly",
        "__os__wheels_rs",
        "__os__wheels_py",
        "__os__wheels_4whl_digest"
    ] }
]

[tasks.install]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Install the distributable artifact into the current environment"
dependencies = [ "uninstall", "__os__set_mode_install"]
run_task = [
    { name = [
        "install_rs",
        "install_py"], condition = { env = { "TD_ON_GA" = "true" } } },
    { name = [
        "__os__preconditions_install",
        "install_rs",
        "install_py",
        "__os__postconditions_install"
    ] }
]

[tasks.install_rs]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Task 'install' for Rust projects"
run_task = [
    { name = [
        "__os__install_rs"
    ] }
]

[tasks.install_py]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Task 'install' for Python projects"
run_task = [
    { name = [
        "__os__install_py_connectors",
        "__os__install_py_tabsdata"
    ] }
]

[tasks.uninstall]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Uninstall the distributable artifact from the current environment"
run_task = [
    { name = [
        "uninstall_rs",
        "uninstall_py",
    ] }
]
[tasks.uninstall_rs]
plugin = "td-task-tracker"
category = "10 - Bundle"
description = "Task 'uninstall' for Rust projects"
run_task = [
    { name = [
        "__os__uninstall_rs"
    ] }
]

[tasks.uninstall_py]
plugin = "td-task-tracker"
category = "10 - Bundle"
run_task = [
    { name = [
        "__os__uninstall_py_tabsdata",
        "__os__uninstall_py_connectors"
    ] }
]

[tasks.env]
plugin = "td-task-tracker"
category = "70 - Debug"
description = "Show all environment variables available to cargo make"
run_task = [
    { name = [
        "__os__env"
    ] }
]

[tasks.duck]
plugin = "td-task-tracker"
category = "70 - Debug"
description = "Utility task for DuckScript code explorations"
run_task = [
    { name = [
        "__os__duck"
    ] }
]
